name: LLM Integration Tests

# Reusable workflow for LLM integration tests
# Can be triggered manually or called from other workflows

on:
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      scenario:
        description: 'Specific scenario to run (leave empty for all)'
        required: false
        type: string
        default: ''

  # Allow other workflows to call this
  workflow_call:

jobs:
  llm-tests:
    runs-on: windows-latest
    permissions:
      id-token: write   # Required for Azure OIDC
      contents: read

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Azure Login (OIDC)
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Run LLM Integration Tests
      env:
        AZURE_OPENAI_ENDPOINT: ${{ vars.AZURE_OPENAI_ENDPOINT }}
      run: |
        cd tests/Sbroenne.WindowsMcp.LLM.Tests

        $scenario = "${{ inputs.scenario }}"
        if ($scenario) {
          Write-Output "Running specific scenario: $scenario"
          ./Run-LLMTests.ps1 -Build -Scenario $scenario
        } else {
          Write-Output "Running all LLM test scenarios"
          ./Run-LLMTests.ps1 -Build
        }
      shell: pwsh

    - name: Generate Job Summary
      if: always()
      run: |
        $reportsDir = "tests/Sbroenne.WindowsMcp.LLM.Tests/TestResults"
        
        # Start building the summary
        $summary = @"
        ## üß™ LLM Integration Test Results

        "@

        $totalPassed = 0
        $totalFailed = 0
        $scenarioResults = @()

        # Parse all JSON report files
        $jsonFiles = Get-ChildItem -Path $reportsDir -Filter "*-report.json" -ErrorAction SilentlyContinue
        
        if ($jsonFiles.Count -eq 0) {
          $summary += "`n‚ö†Ô∏è No test reports found.`n"
        } else {
          foreach ($jsonFile in $jsonFiles) {
            try {
              $report = Get-Content $jsonFile.FullName -Raw | ConvertFrom-Json
              $scenarioName = $jsonFile.BaseName -replace '-report$', ''
              
              $passed = $report.summary.passed
              $failed = $report.summary.failed
              $total = $report.summary.total
              $successRate = if ($total -gt 0) { [math]::Round(($passed / $total) * 100, 1) } else { 0 }
              
              $totalPassed += $passed
              $totalFailed += $failed
              
              $status = if ($failed -eq 0) { "‚úÖ" } else { "‚ùå" }
              $scenarioResults += [PSCustomObject]@{
                Name = $scenarioName
                Status = $status
                Passed = $passed
                Failed = $failed
                Total = $total
                Rate = "$successRate%"
              }
            } catch {
              Write-Warning "Failed to parse $($jsonFile.Name): $_"
            }
          }

          # Build results table
          $summary += "| Scenario | Status | Passed | Failed | Rate |`n"
          $summary += "|----------|--------|--------|--------|------|`n"
          
          foreach ($result in $scenarioResults) {
            $summary += "| $($result.Name) | $($result.Status) | $($result.Passed) | $($result.Failed) | $($result.Rate) |`n"
          }

          $overallStatus = if ($totalFailed -eq 0) { "‚úÖ All tests passed" } else { "‚ùå Some tests failed" }
          $summary += "`n**Overall: $overallStatus** ($totalPassed passed, $totalFailed failed)`n"
        }

        # Write to job summary
        $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
        Write-Output "Job summary generated"
        
        # Fail the step if any tests failed
        if ($totalFailed -gt 0) {
          Write-Error "LLM tests failed: $totalFailed test(s) did not pass"
          exit 1
        }
      shell: pwsh

    - name: Upload LLM Test Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: llm-test-reports
        path: tests/Sbroenne.WindowsMcp.LLM.Tests/TestResults/
        retention-days: 30
