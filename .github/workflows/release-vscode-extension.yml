name: Release VS Code Extension

# This workflow builds and releases the Windows MCP VS Code extension
# Triggered by pushing tags matching 'vscode-v*'

on:
  push:
    tags:
      - 'vscode-v*'

jobs:
  release-vscode-extension:
    runs-on: windows-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Extract Version
      run: |
        $tagName = "${{ github.ref_name }}"
        $version = $tagName -replace '^vscode-v', ''
        Write-Output "Version: $version"
        "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: pwsh

    - name: Update MCP Server Version
      run: |
        $version = "${{ env.VERSION }}"

        Write-Output "Updating MCP Server to version $version for bundled executable"

        # Update MCP Server project version
        $mcpCsprojPath = "src/Sbroenne.WindowsMcp/Sbroenne.WindowsMcp.csproj"
        $mcpContent = Get-Content $mcpCsprojPath -Raw
        $mcpContent = $mcpContent -replace '<Version>[\d\.]+</Version>', "<Version>$version</Version>"
        $mcpContent = $mcpContent -replace '<AssemblyVersion>[\d\.]+\.[\d\.]+</AssemblyVersion>', "<AssemblyVersion>$version.0</AssemblyVersion>"
        $mcpContent = $mcpContent -replace '<FileVersion>[\d\.]+\.[\d\.]+</FileVersion>', "<FileVersion>$version.0</FileVersion>"
        Set-Content $mcpCsprojPath $mcpContent

        Write-Output "Updated MCP Server project to version $version"
      shell: pwsh

    - name: Update Extension Version
      run: |
        $version = "${{ env.VERSION }}"

        Write-Output "Updating VS Code extension to version $version"

        # Update package.json version - check if already set
        cd vscode-extension
        $packageJsonPath = 'package.json'
        $packageJsonContent = Get-Content $packageJsonPath | ConvertFrom-Json

        if ($packageJsonContent.version -ne $version) {
          npm version "$version" --no-git-tag-version
          Write-Output "Updated package.json to version $version"
        } else {
          Write-Output "package.json version is already $version, skipping npm version"
        }

        # Update CHANGELOG.md - replace [Unreleased] with new version
        $date = Get-Date -Format 'yyyy-MM-dd'
        $changelogPath = 'CHANGELOG.md'
        if (Test-Path $changelogPath) {
          $changelogContent = Get-Content $changelogPath -Raw
          # Replace [Unreleased] with the new version and add a fresh [Unreleased] section
          $newUnreleased = "## [Unreleased]`n`n## [$version] - $date"
          $changelogContent = $changelogContent -replace '## \[Unreleased\]', $newUnreleased
          Set-Content $changelogPath $changelogContent
          Write-Output "Updated CHANGELOG.md: [Unreleased] -> [$version] - $date"
        }

        Write-Output "Updated extension version to $version"
        "PACKAGE_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: pwsh

    - name: Install Dependencies
      run: |
        cd vscode-extension
        npm install

    - name: Build and Package Extension
      run: |
        cd vscode-extension
        # Run the package script which does: build:mcp-server + vsce package
        npm run package

        $version = "${{ env.PACKAGE_VERSION }}"

        # vsce creates filename based on package.json name
        $actualVsix = Get-ChildItem -Path . -Filter "*.vsix" -File | Select-Object -First 1
        if (-not $actualVsix) {
          Write-Error "No VSIX file found"
          exit 1
        }

        $targetName = "windows-mcp-$version.vsix"
        if ($actualVsix.Name -ne $targetName) {
          Rename-Item $actualVsix.FullName -NewName $targetName
          Write-Output "Renamed $($actualVsix.Name) to $targetName"
        }

        Write-Output "Created $targetName"
        Get-Item $targetName | Format-Table Name, Length
        "VSIX_PATH=vscode-extension/$targetName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: pwsh

    - name: Publish to VS Code Marketplace
      uses: HaaLeo/publish-vscode-extension@v2
      with:
        pat: ${{ secrets.VSCE_TOKEN }}
        registryUrl: https://marketplace.visualstudio.com
        extensionFile: ${{ env.VSIX_PATH }}
      continue-on-error: true
      id: publishToMarketplace

    - name: Create GitHub Release
      run: |
        $tagName = "${{ github.ref_name }}"
        $version = "${{ env.PACKAGE_VERSION }}"
        $vsixFile = "${{ env.VSIX_PATH }}"

        $marketplaceStatus = "Not published"
        if ("${{ steps.publishToMarketplace.outcome }}" -eq "success") {
          $marketplaceStatus = "Published to VS Code Marketplace"
        }

        $notes = @"
        ## Windows MCP Server VS Code Extension $tagName

        ### Control Windows from VS Code with AI

        This extension registers the Windows MCP server with VS Code, enabling AI assistants to control mouse, keyboard, windows, and capture screenshots.

        ### Installation Options

        **Option 1: VS Code Marketplace** - Search for 'Windows MCP Server' and click Install
        **Option 2: Manual VSIX** - Download windows-mcp-$version.vsix below and install via VS Code

        ### Publishing Status: $marketplaceStatus

        ### Key Features
        - Zero Configuration - Automatic MCP server registration
        - Mouse control - click, move, drag, scroll
        - Keyboard control - type, press keys, combinations
        - Window management - list, find, activate, move, resize
        - Screenshot capture - screens, windows, regions
        - Works in all VS Code workspaces

        ### Requirements
        - Windows 11
        - VS Code 1.106.0+
        - .NET 8 Runtime (auto-acquired via ms-dotnettools.vscode-dotnet-runtime)

        ### Documentation
        - [Main Repository](https://github.com/sbroenne/mcp-windows)
        "@

        $notes | Out-File -FilePath "release_notes.md" -Encoding utf8

        gh release create "$tagName" "$vsixFile" --title "Windows MCP Server VS Code Extension $tagName" --notes-file release_notes.md

        Write-Output "Released Windows MCP Server VS Code Extension $version"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      shell: pwsh
