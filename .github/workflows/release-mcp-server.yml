name: Release MCP Server

# This workflow builds and releases the standalone Windows MCP Server
# Triggered by pushing tags matching 'mcp-v*'

on:
  push:
    tags:
      - 'mcp-v*'

jobs:
  build:
    runs-on: windows-latest

    strategy:
      matrix:
        rid: [win-x64, win-arm64]

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    - name: Extract Version
      run: |
        $tagName = "${{ github.ref_name }}"
        $version = $tagName -replace '^mcp-v', ''
        Write-Output "Version: $version"
        "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: pwsh

    - name: Update Version in Project
      run: |
        $version = "${{ env.VERSION }}"
        $csprojPath = "src/Sbroenne.WindowsMcp/Sbroenne.WindowsMcp.csproj"
        $content = Get-Content $csprojPath -Raw
        $content = $content -replace '<Version>[\d\.]+</Version>', "<Version>$version</Version>"
        $content = $content -replace '<AssemblyVersion>[\d\.]+\.[\d\.]+</AssemblyVersion>', "<AssemblyVersion>$version.0</AssemblyVersion>"
        $content = $content -replace '<FileVersion>[\d\.]+\.[\d\.]+</FileVersion>', "<FileVersion>$version.0</FileVersion>"
        Set-Content $csprojPath $content
        Write-Output "Updated project to version $version"
      shell: pwsh

    - name: Restore Dependencies
      run: dotnet restore

    - name: Publish (Self-contained single-file)
      run: |
        $rid = "${{ matrix.rid }}"
        dotnet publish src/Sbroenne.WindowsMcp/Sbroenne.WindowsMcp.csproj `
          -c Release `
          -r $rid `
          -o "publish/$rid" `
          -p:SelfContained=true `
          -p:PublishSingleFile=true `
          -p:EnableCompressionInSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:PublishReadyToRun=false
      shell: pwsh

    - name: Create Release Archive
      run: |
        $version = "${{ env.VERSION }}"
        $rid = "${{ matrix.rid }}"

        $publishDir = "publish/$rid"
        if (!(Test-Path $publishDir)) {
          Write-Error "Publish directory not found: $publishDir"
        }

        $zipName = "windows-mcp-server-$version-$rid.zip"
        Compress-Archive -Path "$publishDir/*" -DestinationPath $zipName

        Write-Output "Created release archive: $zipName"
        Get-ChildItem *.zip | Format-Table Name, Length
      shell: pwsh

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-${{ matrix.rid }}
        path: windows-mcp-server-*.zip
        retention-days: 1

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Extract Version
      run: |
        tagName="${{ github.ref_name }}"
        version="${tagName#mcp-v}"
        echo "Version: $version"
        echo "VERSION=$version" >> $GITHUB_ENV

    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        pattern: release-*
        merge-multiple: true

    - name: List Artifacts
      run: |
        echo "Downloaded artifacts:"
        ls -la artifacts/

    - name: Assemble Release Notes
      run: |
        tagName="${{ github.ref_name }}"
        version="${{ env.VERSION }}"

        cat > release_notes.md << EOF
        ## Windows MCP Server ${tagName}

        MCP server for Windows automation - UI automation, mouse, keyboard, window management, and screenshots.

        ### Downloads (no .NET runtime required)

        | File | Architecture |
        |------|--------------|
        | windows-mcp-server-${version}-win-x64.zip | x64 |
        | windows-mcp-server-${version}-win-arm64.zip | ARM64 |

        Each zip contains a single, self-contained Sbroenne.WindowsMcp.exe. Pick the RID that matches your machine (x64 for most PCs, ARM64 for Surface/ARM dev kits).

        ### Available Tools

        | Tool | Description |
        |------|-------------|
        | ui_automation | Find UI elements, interact with controls, OCR text recognition |
        | mouse_control | Click, double-click, right-click, move, drag, scroll, get_position |
        | keyboard_control | Type text, press keys, combinations, sequences |
        | window_management | List, find, activate, minimize, maximize, move, resize, move_to_monitor |
        | screenshot_control | Capture screens, monitors, windows, or regions |

        ### Usage

        1. Download the zip for your architecture
        2. Extract the zip (contains Sbroenne.WindowsMcp.exe)
        3. Run Sbroenne.WindowsMcp.exe or add to your MCP client config

        ### MCP Client Configuration

        \`\`\`json
        {
          "mcpServers": {
            "windows-mcp": {
              "command": "path/to/Sbroenne.WindowsMcp.exe"
            }
          }
        }
        \`\`\`

        See [README](https://github.com/sbroenne/mcp-windows/blob/main/README.md) for full documentation.
        EOF

    - name: Create GitHub Release
      run: |
        tagName="${{ github.ref_name }}"
        gh release create "$tagName" \
          artifacts/*.zip \
          --repo ${{ github.repository }} \
          --title "Windows MCP Server $tagName" \
          --notes-file release_notes.md
        echo "Released Windows MCP Server ${{ env.VERSION }}"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
