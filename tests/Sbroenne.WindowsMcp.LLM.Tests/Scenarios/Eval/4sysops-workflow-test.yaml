# =============================================================================
# 4sysops Real-World Workflow Test - sbroenne/mcp-windows
# =============================================================================
#
# Recreates the exact tasks from the 4sysops article:
# "Windows automation with AI via MCP"
# https://4sysops.com/archives/windows-automation-with-ai-via-mcp/
#
# Original 4sysops tasks:
#   1. Create 10 files (0.txt - 9.txt) in Documents folder
#   2. Check Windows Update for available updates
#   3. Install Firefox (skipped - triggers UAC which AI cannot handle)
#
# Tools Covered:
#   - app: Launch applications
#   - ui_type / keyboard_control: Type content
#   - file_save: Save files
#   - window_management: Window operations
#   - ui_click: Click UI elements (for Windows Update)
#
# Prerequisites:
#   - Windows 10/11
#   - Windows MCP Server (sbroenne/mcp-windows)
#   - Environment: AZURE_OPENAI_ENDPOINT
#
# Note: Firefox installation is omitted because winget triggers UAC prompts
# that AI cannot interact with (Windows security boundary).
#
# =============================================================================

criteria:
  success_rate: 1 # 100%

providers:
  - name: azure-openai-gpt41
    type: AZURE
    auth_type: entra_id
    model: gpt-4.1
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview
    retry:
      retry_on_429: true
      max_retries: 5

  - name: azure-openai-gpt52
    type: AZURE
    auth_type: entra_id
    model: gpt-5.2-chat
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview
    retry:
      retry_on_429: true
      max_retries: 5

servers:
  - name: windows-mcp
    type: stdio
    command: "{{SERVER_COMMAND}}"
    server_delay: 10s

agents:
  - name: gpt41-agent
    servers:
      - name: windows-mcp
    provider: azure-openai-gpt41
    system_prompt: |
      You are {{AGENT_NAME}}, an autonomous Windows automation agent.

      RULES:
      - Execute tasks IMMEDIATELY without asking for confirmation
      - NEVER ask "Would you like me to..." or request clarification
      - Make reasonable assumptions and proceed
      - Report results after completion
    clarification_detection:
      enabled: true
      level: warning
      judge_provider: azure-openai-gpt52

  - name: gpt52-agent
    servers:
      - name: windows-mcp
    provider: azure-openai-gpt52
    system_prompt: |
      You are {{AGENT_NAME}}, an autonomous Windows automation agent.

      RULES:
      - Execute tasks IMMEDIATELY without asking for confirmation
      - NEVER ask "Would you like me to..." or request clarification
      - Make reasonable assumptions and proceed
      - Report results after completion
    clarification_detection:
      enabled: true
      level: warning
      judge_provider: azure-openai-gpt52

ai_summary:
  enabled: true
  judge_provider: azure-openai-gpt52

settings:
  verbose: true
  max_iterations: 50  # 10 files = ~40 iterations (4 per file)
  session_delay: 5s
  test_delay: 2s
  tool_timeout: 60s

sessions:
  # =========================================================================
  # Session 1: Create 10 Files in Documents (4sysops Task 1)
  # =========================================================================
  - name: 4sysops Task 1 - Create 10 Files
    agents:
      - gpt41-agent
      - gpt52-agent
    tests:
      - name: "Create 10 numbered files in Documents"
        description: "Create 0.txt through 9.txt in Documents folder (exact 4sysops task)"
        prompt: |
          Create 10 numbered text files in this folder: {{TEMP_DIR}}/4sysops-documents-{{RUN_ID}}/

          Files needed: 0.txt, 1.txt, 2.txt, 3.txt, 4.txt, 5.txt, 6.txt, 7.txt, 8.txt, 9.txt
          Each file should contain just its number (e.g., "0" in 0.txt, "1" in 1.txt, etc.)

          Report "VERIFIED: Created 10 numbered files (0.txt - 9.txt)" when complete.
        assertions:
          # OUTCOME: Files were created (any method is valid - UI automation or PowerShell)
          - type: output_regex
            pattern: "(?i)(created.*files|files.*created|0\\.txt|9\\.txt|10.*files)"

          # OUTCOME: Agent verified completion
          - type: output_regex
            pattern: "(?i)(verified|complete|success|all.*files)"

          # QUALITY: Only used real tools
          - type: no_hallucinated_tools

          # QUALITY: No errors during execution
          - type: no_error_messages

          # QUALITY: Agent executed directly without asking for confirmation
          - type: no_clarification_questions

          # QUALITY: No rate limit errors encountered
          - type: no_rate_limit_errors

  # =========================================================================
  # Session 2: Check Windows Update (4sysops Task 2)
  # =========================================================================
  - name: 4sysops Task 2 - Check Windows Update
    agents:
      - gpt41-agent
      - gpt52-agent
    tests:
      - name: "Check for Windows Updates"
        description: "Open Windows Update settings and report available updates"
        prompt: |
          Check Windows Update for available updates.

          Report any available updates you find (names, KB numbers, etc.)
          Close Settings when done.

          Report "VERIFIED: Windows Update checked" and list any available updates.
        assertions:
          # REQUIRED: Must launch Settings or use keyboard to open it
          - anyOf:
              - type: tool_called
                tool: app
              - type: tool_called
                tool: keyboard_control

          # OUTCOME: Agent interacted with Windows Update UI
          - anyOf:
              - type: tool_called
                tool: ui_click
              - type: tool_called
                tool: ui_read
              - type: tool_called
                tool: screenshot_control
              - type: output_regex
                pattern: "(?i)(update|KB[0-9]+|no.*updates|up.*to.*date)"

          # OUTCOME: Agent reported findings
          - type: output_regex
            pattern: "(?i)(verified|update|checked|available|installed|pending)"

          # QUALITY: Only used real tools
          - type: no_hallucinated_tools

          # QUALITY: No errors during execution
          - type: no_error_messages

          # QUALITY: Agent executed directly without asking for confirmation
          - type: no_clarification_questions

          # QUALITY: No rate limit errors encountered
          - type: no_rate_limit_errors

  # =========================================================================
  # Session 3: Verify Firefox Installation (4sysops Task 3 - Modified)
  # =========================================================================
  # Note: Original task was "install Firefox" but winget triggers UAC.
  # Modified to verify if Firefox is installed instead.
  - name: 4sysops Task 3 - Verify Firefox
    agents:
      - gpt41-agent
      - gpt52-agent
    tests:
      - name: "Verify Firefox installation status"
        description: "Check if Firefox is installed (without triggering UAC)"
        prompt: |
          Check if Mozilla Firefox is installed on this system.

          Report whether Firefox is installed and what version if found.
          Do NOT attempt to install Firefox - just check if it's already there.

          Report "VERIFIED: Firefox [installed/not installed]" with version if found.
        assertions:
          # REQUIRED: Must launch Settings
          - type: tool_called
            tool: app

          # OUTCOME: Agent searched for Firefox
          - anyOf:
              - type: tool_called
                tool: ui_type
              - type: tool_called
                tool: ui_find
              - type: tool_called
                tool: keyboard_control
              - type: output_regex
                pattern: "(?i)(firefox|mozilla)"

          # OUTCOME: Agent reported finding
          - type: output_regex
            pattern: "(?i)(verified|firefox.*(installed|found|not found|not installed)|version)"

          # QUALITY: Only used real tools
          - type: no_hallucinated_tools

          # QUALITY: No errors during execution
          - type: no_error_messages

          # QUALITY: Agent executed directly without asking for confirmation
          - type: no_clarification_questions

          # QUALITY: No rate limit errors encountered
          - type: no_rate_limit_errors
