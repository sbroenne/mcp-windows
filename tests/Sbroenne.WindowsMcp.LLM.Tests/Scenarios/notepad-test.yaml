# Windows Notepad Test
# Testing framework: Agent Benchmark
# https://github.com/mykhaliev/agent-benchmark
#
# Tests:
# 1. Complete Notepad workflow - type text, close without saving
# 2. Notepad save workflow - type text, save to unique file, verify with filesystem
#
# Prerequisites:
# - Windows 10/11
# - Windows MCP Server
# - Filesystem MCP Server (for save test verification)
# - Environment variables set:
#   - AZURE_OPENAI_ENDPOINT: Azure OpenAI endpoint
#   - TEST_RESULTS_PATH: Directory for output files


criteria:
  success_rate: 1 # 100%

providers:
  - name: azure-openai-gpt4o
    type: AZURE
    auth_type: entra_id  # Uses DefaultAzureCredential - no API key needed
    model: gpt-4o
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview

  - name: azure-openai-gpt41
    type: AZURE
    auth_type: entra_id  # Uses DefaultAzureCredential - no API key needed
    model: gpt-4.1
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview

  - name: azure-openai-gpt5-chat
    type: AZURE
    auth_type: entra_id  # Uses DefaultAzureCredential - no API key needed
    model: gpt-5.2-chat
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview


servers:
  - name: windows-mcp
    type: stdio
    command: "{{SERVER_COMMAND}}"
    server_delay: 10s

  - name: filesystem
    type: stdio
    command: "npx -y @modelcontextprotocol/server-filesystem {{TEST_RESULTS_PATH}}"
    server_delay: 10s

agents:
  - name: gpt4o-agent
    servers:
      - name: windows-mcp
      - name: filesystem
    provider: azure-openai-gpt4o

  - name: gpt5-chat-agent
    servers:
      - name: windows-mcp
      - name: filesystem
    provider: azure-openai-gpt5-chat

  - name: gpt41-agent
    servers:
      - name: windows-mcp
      - name: filesystem
    provider: azure-openai-gpt41

settings:
  verbose: true
  max_iterations: 15      # launch + type + save + close + verify + buffer
  test_delay: 60s         # Longer delay to avoid rate limits between agents

sessions:
  - name: Notepad Workflow
    tests:
      - name: "Type and close without saving"
        description: "Open Notepad, type text, close without saving"
        prompt: |
          Open Notepad, type "Hello World", then close it without saving.
        assertions:
          # OUTCOME: LLM verified no Notepad window open
          - type: output_regex
            pattern: "(?i)(no.*(notepad|window).*(open|found|running)|verified|notepad.*(closed|not found))"

          # OUTCOME: Proof that "Hello World" was typed
          - type: output_regex
            pattern: "(?i)hello\\s*world"

          # SAFETY: No failure indicators
          - type: output_not_contains
            value: "failed"

          # QUALITY: Only used real tools
          - type: no_hallucinated_tools

          # QUALITY: No errors during execution
          - type: no_error_messages

          # REQUIRED: Must use window_management to launch/close/find windows
          - type: tool_called
            tool: window_management

          # VERIFY: Notepad was launched with correct program
          - type: tool_param_equals
            tool: window_management
            params:
              action: "launch"
              programPath: "notepad.exe"

          # VERIFY: Launch succeeded (ok: true in JSON response)
          - type: tool_result_matches_json
            tool: window_management
            path: "$.ok"
            value: true

          # FLEXIBLE: Text input can use different tools depending on the LLM
          # GPT-4.1 often uses keyboard_control, GPT-4o may use ui_automation
          - anyOf:
              - type: tool_called
                tool: keyboard_control
              - type: tool_called
                tool: ui_automation

          # VERIFY: Window was closed (find returned empty or no matches)
          - anyOf:
              # Either the output confirms closure
              - type: output_regex
                pattern: "(?i)(no.*windows?.*found|0.*windows?|empty.*list|windows.*\\[\\])"

          # VERIFY: "Hello World" was typed using one of these methods
          - anyOf:
              # Via keyboard_control with the text
              - type: tool_param_matches_regex
                tool: keyboard_control
                params:
                  text: "(?i)hello.*world"
              # Via ui_automation type action
              - type: tool_param_equals
                tool: ui_automation
                params:
                  action: "type"
              # Via ui_automation setValue action
              - type: tool_param_equals
                tool: ui_automation
                params:
                  action: "set_value"

          # PERFORMANCE: Complete within 60 seconds
          - type: max_latency_ms
            value: 60000

          # EFFICIENCY: Stay under token limits
          - type: max_tokens
            value: 60000

      - name: "Type and save to file"
        description: "Open Notepad, type text, save to unique file, verify with filesystem"
        prompt: |
          Open Notepad, type some text, save to {{TEST_RESULTS_PATH}}\notepad-test-{{now format="epoch"}}.txt, and close it.
          Verify the file was saved.
        assertions:
          # OUTCOME: LLM verified the file was saved (flexible matching)
          - type: output_regex
            pattern: "(?i)(file.*(saved|created|exists|verified)|saved.*successfully|isFile.*true)"

          # SAFETY: No failure indicators
          - type: output_not_contains
            value: "FAILED"

          # QUALITY: Only used real tools
          - type: no_hallucinated_tools

          # QUALITY: No errors during execution
          - type: no_error_messages

          # REQUIRED: Must use window_management to launch Notepad
          - type: tool_called
            tool: window_management

          # VERIFY: Notepad was launched
          - type: tool_param_equals
            tool: window_management
            params:
              action: "launch"
              programPath: "notepad.exe"

          # FLEXIBLE: Text input can use different tools
          - anyOf:
              - type: tool_called
                tool: keyboard_control
              - type: tool_called
                tool: ui_automation

          # PERFORMANCE: Complete within 90 seconds
          - type: max_latency_ms
            value: 90000

          # EFFICIENCY: Stay under token limits
          - type: max_tokens
            value: 120000

          # VERIFICATION: Must use filesystem tools to verify the file exists
          - anyOf:
              - type: tool_called
                tool: read_file
              - type: tool_called
                tool: list_directory
              - type: tool_called
                tool: get_file_info

