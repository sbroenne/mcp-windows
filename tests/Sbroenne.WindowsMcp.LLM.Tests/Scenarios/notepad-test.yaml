# Windows Notepad Test
# Testing framework: Agent Benchmark
# https://github.com/mykhaliev/agent-benchmark
#
# Tests:
# 1. Complete Notepad workflow - type text, close without saving
# 2. Notepad save workflow - type text, save to unique file, verify with filesystem
#
# Prerequisites:
# - Windows 10/11
# - Windows MCP Server
# - Filesystem MCP Server (for save test verification)
# - Environment variables set:
#   - AZURE_OPENAI_ENDPOINT: Azure OpenAI endpoint
#   - TEST_RESULTS_PATH: Directory for output files


criteria:
  success_rate: 1 # 100%

providers:
  - name: azure-openai-gpt4o
    type: AZURE
    auth_type: entra_id  # Uses DefaultAzureCredential - no API key needed
    model: gpt-4o
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview

  - name: azure-openai-gpt41
    type: AZURE
    auth_type: entra_id  # Uses DefaultAzureCredential - no API key needed
    model: gpt-4.1
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview

  - name: azure-openai-gpt5-chat
    type: AZURE
    auth_type: entra_id  # Uses DefaultAzureCredential - no API key needed
    model: gpt-5.2-chat
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview


servers:
  - name: windows-mcp
    type: stdio
    command: "{{SERVER_COMMAND}}"
    server_delay: 10s

  - name: filesystem
    type: stdio
    command: "npx -y @modelcontextprotocol/server-filesystem {{TEST_RESULTS_PATH}}"
    server_delay: 10s

agents:
  - name: gpt4o-agent
    servers:
      - name: windows-mcp
      - name: filesystem
    provider: azure-openai-gpt4o

  - name: gpt5-chat-agent
    servers:
      - name: windows-mcp
      - name: filesystem
    provider: azure-openai-gpt5-chat

  - name: gpt41-agent
    servers:
      - name: windows-mcp
      - name: filesystem
    provider: azure-openai-gpt41

settings:
  verbose: true
  max_iterations: 15      # launch + type + save + close + verify + buffer
  test_delay: 1s         # Longer delay to avoid rate limits between agents

sessions:
  # ==========================================================================
  # Session 1: Type and close without saving (multi-step)
  # ==========================================================================
  - name: "Type and close without saving"
    tests:
      # Step 1: Launch Notepad
      - name: "Step 1: Launch Notepad"
        prompt: |
          Launch Notepad.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: app
          - type: tool_param_equals
            tool: app
            params:
              programPath: "notepad.exe"
          - type: tool_result_matches_json
            tool: app
            path: "$.ok"
            value: true
          - type: max_latency_ms
            value: 15000

      # Step 2: Type text
      - name: "Step 2: Type Hello World"
        prompt: |
          Type "Hello World" in the Notepad window.
        assertions:
          - type: no_hallucinated_tools
          - anyOf:
              - type: tool_called
                tool: keyboard_control
              - type: tool_called
                tool: ui_type
          - anyOf:
              - type: tool_param_matches_regex
                tool: keyboard_control
                params:
                  text: "(?i)hello.*world"
              - type: tool_param_matches_regex
                tool: ui_type
                params:
                  text: "(?i)hello.*world"
          - type: max_latency_ms
            value: 20000

      # Step 3: Close without saving
      - name: "Step 3: Close without saving"
        prompt: |
          Close Notepad without saving the document.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: window_management
          - type: output_not_contains
            value: "failed"
          - type: max_latency_ms
            value: 25000

      # Step 4: Verify closed
      - name: "Step 4: Verify Notepad is closed"
        prompt: |
          Verify that Notepad is no longer running.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: window_management
          - type: output_regex
            pattern: "(?i)(no.*(notepad|window)|not.*running|closed|not.*found|0.*match)"
          - type: max_latency_ms
            value: 10000

  # ==========================================================================
  # Session 2: Type and save to file (multi-step)
  # ==========================================================================
  - name: "Type and save to file"
    tests:
      # Step 1: Launch Notepad
      - name: "Step 1: Launch Notepad"
        prompt: |
          Launch Notepad.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: app
          - type: tool_param_equals
            tool: app
            params:
              programPath: "notepad.exe"
          - type: tool_result_matches_json
            tool: app
            path: "$.ok"
            value: true
          - type: max_latency_ms
            value: 15000

      # Step 2: Type text
      - name: "Step 2: Type some text"
        prompt: |
          Type "This is a test for Notepad automation." in the Notepad window.
        assertions:
          - type: no_hallucinated_tools
          - anyOf:
              - type: tool_called
                tool: keyboard_control
              - type: tool_called
                tool: ui_type
          - type: max_latency_ms
            value: 15000

      # Step 3: Save to file
      - name: "Step 3: Save to file"
        prompt: |
          Save the document to {{TEST_RESULTS_PATH}}\notepad-test-{{randomValue type='UUID'}}.txt
        assertions:
          - type: no_hallucinated_tools
          # Can use keyboard_control (Ctrl+S) to trigger save dialog, then ui_file to complete
          # Or use ui_file directly which handles both triggering and completing the save
          # Or use ui_click to manually navigate menus (not recommended but allowed)
          - anyOf:
              - type: tool_called
                tool: ui_file
              - type: tool_called
                tool: keyboard_control
              - type: tool_called
                tool: ui_click
          # Must NOT contain error indicators
          - type: output_not_contains
            value: "failed"
          - type: output_not_contains
            value: "unable to"
          - type: output_not_contains
            value: "SecureDesktop"
          - type: output_not_contains
            value: "cannot"
          - type: max_latency_ms
            value: 30000

      # Step 4: Close Notepad
      - name: "Step 4: Close Notepad"
        prompt: |
          Close Notepad.
        assertions:
          - type: no_hallucinated_tools
          # window_management(close) or keyboard_control(Alt+F4) are both valid
          - anyOf:
              - type: tool_called
                tool: window_management
              - type: tool_called
                tool: keyboard_control
          - type: max_latency_ms
            value: 15000

      # Step 5: Verify file exists
      - name: "Step 5: Verify file was saved"
        prompt: |
          Verify that the file was saved by checking if it exists and contains the text we typed.
        assertions:
          - type: no_hallucinated_tools
          - anyOf:
              - type: tool_called
                tool: read_file
              - type: tool_called
                tool: read_text_file
              - type: tool_called
                tool: list_directory
              - type: tool_called
                tool: get_file_info
          # Must NOT indicate file doesn't exist
          - type: output_not_contains
            value: "ENOENT"
          - type: output_not_contains
            value: "does not exist"
          - type: output_not_contains
            value: "not found"
          - type: output_not_contains
            value: "no such file"
          # Positive confirmation that file exists and contains expected content
          - type: output_regex
            pattern: "(?i)(isFile.*true|\"size\":\\s*[0-9]|file exists|exists.*true|verification.*success|This is a test)"
          - type: max_latency_ms
            value: 15000

