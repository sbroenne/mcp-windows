# =============================================================================
# Window Management Test - App and Window Management Tools
# =============================================================================
#
# User Story 2: App and Window Management (Priority: P1)
#
# Tests: app tool and all 10 window_management actions
#
# Tools Covered:
#   - app: Launch applications
#   - window_management with actions:
#     1. list - List all windows
#     2. find - Find window by title/process
#     3. activate - Bring window to foreground
#     4. minimize - Minimize window
#     5. maximize - Maximize window
#     6. restore - Restore from minimized/maximized
#     7. close - Close window
#     8. move - Move window to position
#     9. resize - Resize window dimensions
#     10. wait_for - Wait for window state
#
# Prerequisites:
#   - Windows 10/11
#   - Windows MCP Server
#   - Environment: AZURE_OPENAI_ENDPOINT
#
# =============================================================================

criteria:
  success_rate: 1  # 100% required

providers:
  - name: azure-openai-gpt41
    type: AZURE
    auth_type: entra_id
    model: gpt-4.1
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview
    retry:
      retry_on_429: true
      max_retries: 5
  - name: azure-openai-gpt5-chat
    type: AZURE
    auth_type: entra_id
    model: gpt-5.2-chat
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview
    retry:
      retry_on_429: true
      max_retries: 5
servers:
  - name: windows-mcp
    type: stdio
    command: "{{SERVER_COMMAND}}"
    server_delay: 10s

agents:
  - name: gpt41-agent
    servers:
      - name: windows-mcp
    provider: azure-openai-gpt41
    system_prompt: |
      You are {{AGENT_NAME}}, an autonomous Windows automation agent using {{PROVIDER_NAME}}.
      Session: {{SESSION_NAME}}

      CRITICAL RULES:
      - Execute all tasks IMMEDIATELY without asking for confirmation
      - NEVER ask "Would you like me to...", "Should I proceed...", or similar questions
      - NEVER request clarification - make reasonable assumptions and proceed
      - Use available tools directly to complete the requested tasks
      - Report results after completion, not before starting
    clarification_detection:
      enabled: true
      level: warning
      use_builtin_patterns: true

  - name: gpt5-chat-agent
    servers:
      - name: windows-mcp
    provider: azure-openai-gpt5-chat
    system_prompt: |
      You are {{AGENT_NAME}}, an autonomous Windows automation agent using {{PROVIDER_NAME}}.
      Session: {{SESSION_NAME}}

      CRITICAL RULES:
      - Execute all tasks IMMEDIATELY without asking for confirmation
      - NEVER ask "Would you like me to...", "Should I proceed...", or similar questions
      - NEVER request clarification - make reasonable assumptions and proceed
      - Use available tools directly to complete the requested tasks
      - Report results after completion, not before starting
    clarification_detection:
      enabled: true
      level: warning
      use_builtin_patterns: true

settings:
  verbose: true
  max_iterations: 15


sessions:
  # ==========================================================================
  # Session 1: Launch and Find - app, window_management(find), window_management(list)
  # ==========================================================================
  - name: "Launch and Find"
    tests:
      - name: "Cleanup - Close existing Notepad windows"
        prompt: |
          Close all Notepad windows if any are open.
        assertions:
          - type: no_hallucinated_tools

      - name: "Launch Notepad"
        prompt: |
          Launch Notepad.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: app
          - type: tool_param_equals
            tool: app
            params:
              programPath: "notepad.exe"

      - name: "List all open windows"
        prompt: |
          List all currently open windows on the desktop.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: window_management
          - type: tool_param_equals
            tool: window_management
            params:
              action: "list"
          - type: output_regex
            pattern: "(?i)(notepad|window|title)"

      - name: "Find the Notepad window"
        prompt: |
          Find the Notepad window that is currently open.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: window_management
          - type: tool_param_equals
            tool: window_management
            params:
              action: "find"
          - type: output_regex
            pattern: "(?i)(notepad|found|window|handle)"

      - name: "Close Notepad"
        prompt: |
          Close Notepad without saving any changes.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: window_management

  # ==========================================================================
  # Session 2: Window State - minimize, maximize, restore, activate
  # ==========================================================================
  - name: "Window State"
    tests:
      - name: "Cleanup - Close existing Notepad windows"
        prompt: |
          Close all Notepad windows if any are open.
        assertions:
          - type: no_hallucinated_tools

      - name: "Launch Notepad"
        prompt: |
          Launch Notepad.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: app

      - name: "Minimize the Notepad window"
        prompt: |
          Minimize the Notepad window.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: window_management
          - type: tool_param_equals
            tool: window_management
            params:
              action: "minimize"

      - name: "Restore the Notepad window"
        prompt: |
          Restore the Notepad window from minimized state.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: window_management
          - type: tool_param_equals
            tool: window_management
            params:
              action: "restore"

      - name: "Maximize the Notepad window"
        prompt: |
          Maximize the Notepad window to fill the screen.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: window_management
          - type: tool_param_equals
            tool: window_management
            params:
              action: "maximize"

      - name: "Restore from maximized"
        prompt: |
          Restore the Notepad window from maximized state to normal size.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: window_management
          - type: tool_param_equals
            tool: window_management
            params:
              action: "restore"

      - name: "Activate the Notepad window"
        prompt: |
          Activate the Notepad window and bring it to the foreground.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: window_management
          - type: tool_param_equals
            tool: window_management
            params:
              action: "activate"

      - name: "Close Notepad"
        prompt: |
          Close Notepad without saving.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: window_management

  # ==========================================================================
  # Session 3: Window Position - move and resize
  # ==========================================================================
  - name: "Window Position"
    tests:
      - name: "Cleanup - Close existing Notepad windows"
        prompt: |
          Close all Notepad windows if any are open.
        assertions:
          - type: no_hallucinated_tools

      - name: "Launch Notepad"
        prompt: |
          Launch Notepad.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: app

      - name: "Move window to top-left corner"
        prompt: |
          Move the Notepad window to position 100, 100 on the screen.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: window_management
          - type: tool_param_equals
            tool: window_management
            params:
              action: "move"

      - name: "Resize window to 800x600"
        prompt: |
          Resize the Notepad window to 800 pixels wide and 600 pixels tall.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: window_management
          - type: tool_param_equals
            tool: window_management
            params:
              action: "resize"

      - name: "Move window to center area"
        prompt: |
          Move the Notepad window to position 300, 200 on the screen.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: window_management
          - type: tool_param_equals
            tool: window_management
            params:
              action: "move"

      - name: "Resize window to smaller size"
        prompt: |
          Resize the Notepad window to 640 pixels wide and 480 pixels tall.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: window_management
          - type: tool_param_equals
            tool: window_management
            params:
              action: "resize"

      - name: "Close Notepad"
        prompt: |
          Close Notepad without saving.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: window_management

  # ==========================================================================
  # Session 4: Window Lifecycle - wait_for and close with options
  # ==========================================================================
  - name: "Window Lifecycle"
    tests:
      - name: "Cleanup - Close existing Notepad windows"
        prompt: |
          Close all Notepad windows if any are open.
        assertions:
          - type: no_hallucinated_tools

      - name: "Launch Notepad"
        prompt: |
          Launch Notepad.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: app

      - name: "Wait for the Notepad window to be ready"
        prompt: |
          Wait for the Notepad window to become fully visible and ready.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: window_management
          - anyOf:
              - type: tool_param_equals
                tool: window_management
                params:
                  action: "wait_for"
              - type: tool_param_equals
                tool: window_management
                params:
                  action: "wait_for_state"
          - type: output_regex
            pattern: "(?i)(notepad|ready|visible|found|success)"

      - name: "Type some text"
        prompt: |
          Type "Lifecycle test" in Notepad.
        assertions:
          - type: no_hallucinated_tools
          - anyOf:
              - type: tool_called
                tool: ui_type
              - type: tool_called
                tool: keyboard_control

      - name: "Close Notepad and discard changes"
        prompt: |
          Close the Notepad window and discard any unsaved changes.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: window_management
          - type: tool_param_equals
            tool: window_management
            params:
              action: "close"

      - name: "Verify Notepad is closed"
        prompt: |
          Verify that Notepad is no longer running.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: window_management
          - type: output_regex
            pattern: "(?i)(no.*notepad|not.*found|closed|not.*running|0.*match)"

