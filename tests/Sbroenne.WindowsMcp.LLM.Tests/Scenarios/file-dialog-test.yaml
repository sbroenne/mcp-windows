# =============================================================================
# File Dialog Test - UI File Tools
# =============================================================================
#
# User Story 4: Screenshot and File Tools (Priority: P2) - Part 2
#
# Tests: file_save tool for Save As dialog handling
#
# Tools Covered:
#   - file_save: Handle Save As dialogs in Notepad and Paint
#
# Test Applications:
#   - Notepad: Save text file
#   - Paint: Save image as PNG
#
# Prerequisites:
#   - Windows 10/11
#   - Windows MCP Server
#   - Filesystem MCP Server (for verification)
#   - Environment: AZURE_OPENAI_ENDPOINT, TEST_RESULTS_PATH
#
# =============================================================================

criteria:
  success_rate: 1  # 100% required

providers:
  - name: azure-openai-gpt41
    type: AZURE
    auth_type: entra_id
    model: gpt-4.1
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview
    retry:
      retry_on_429: true
      max_retries: 5
  - name: azure-openai-gpt5-chat
    type: AZURE
    auth_type: entra_id
    model: gpt-5.2-chat
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview
    retry:
      retry_on_429: true
      max_retries: 5
servers:
  - name: windows-mcp
    type: stdio
    command: "{{SERVER_COMMAND}}"
    server_delay: 10s

  - name: filesystem
    type: stdio
    command: "npx -y @modelcontextprotocol/server-filesystem {{TEST_RESULTS_PATH}}"
    server_delay: 10s

agents:
  - name: gpt41-agent
    servers:
      - name: windows-mcp
      - name: filesystem
    provider: azure-openai-gpt41
    system_prompt: |
      You are {{AGENT_NAME}}, an autonomous Windows automation agent using {{PROVIDER_NAME}}.
      Session: {{SESSION_NAME}}

      CRITICAL RULES:
      - Execute all tasks IMMEDIATELY without asking for confirmation
      - NEVER ask "Would you like me to...", "Should I proceed...", or similar questions
      - NEVER request clarification - make reasonable assumptions and proceed
      - Use available tools directly to complete the requested tasks
      - Report results after completion, not before starting
    clarification_detection:
      enabled: true
      level: warning
      use_builtin_patterns: true

  - name: gpt5-chat-agent
    servers:
      - name: windows-mcp
      - name: filesystem
    provider: azure-openai-gpt5-chat
    system_prompt: |
      You are {{AGENT_NAME}}, an autonomous Windows automation agent using {{PROVIDER_NAME}}.
      Session: {{SESSION_NAME}}

      CRITICAL RULES:
      - Execute all tasks IMMEDIATELY without asking for confirmation
      - NEVER ask "Would you like me to...", "Should I proceed...", or similar questions
      - NEVER request clarification - make reasonable assumptions and proceed
      - Use available tools directly to complete the requested tasks
      - Report results after completion, not before starting
    clarification_detection:
      enabled: true
      level: warning
      use_builtin_patterns: true

settings:
  verbose: true
  max_iterations: 15


sessions:
  # ==========================================================================
  # Session 1: Notepad Save - save text file via file_save
  # ==========================================================================
  - name: "Notepad Save"
    tests:
      - name: "Cleanup - Close existing Notepad windows"
        prompt: |
          Close all Notepad windows if any are open.
        assertions:
          - type: no_hallucinated_tools

      - name: "Launch Notepad"
        prompt: |
          Open Notepad.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: app

      - name: "Type some text"
        prompt: |
          Type "File dialog test content - this text will be saved to a file." in Notepad.
        assertions:
          - type: no_hallucinated_tools
          - anyOf:
              - type: tool_called
                tool: ui_type
              - type: tool_called
                tool: keyboard_control

      - name: "Save the file"
        prompt: |
          Save the document to {{TEST_RESULTS_PATH}}\notepad-file-test-{{randomValue type='UUID'}}.txt
        assertions:
          - type: no_hallucinated_tools
          # Can use file_save to handle save dialog, or keyboard shortcuts + manual dialog navigation
          - anyOf:
              - type: tool_called
                tool: file_save
              - type: tool_called
                tool: keyboard_control
              - type: tool_called
                tool: ui_click
          - type: output_not_contains
            value: "failed"
          - type: output_not_contains
            value: "SecureDesktop"

      - name: "Close Notepad"
        prompt: |
          Close Notepad.
        assertions:
          - type: no_hallucinated_tools

  # ==========================================================================
  # Session 2: Paint Save - save image as PNG via file_save
  # ==========================================================================
  - name: "Paint Save"
    tests:
      - name: "Cleanup - Close existing Paint windows"
        prompt: |
          Close all Paint windows if any are open.
        assertions:
          - type: no_hallucinated_tools

      - name: "Launch Paint"
        prompt: |
          Open Microsoft Paint.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: app

      - name: "Draw something simple"
        prompt: |
          Draw a simple diagonal line across the canvas so there is something to save.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: mouse_control

      - name: "Save the image as PNG"
        prompt: |
          Save the image as a PNG file to {{TEST_RESULTS_PATH}}\paint-file-test-{{randomValue type='UUID'}}.png
        assertions:
          - type: no_hallucinated_tools
          # Can use file_save to handle save dialog, or keyboard shortcuts + manual dialog navigation
          - anyOf:
              - type: tool_called
                tool: file_save
              - type: tool_called
                tool: keyboard_control
              - type: tool_called
                tool: ui_click
          - type: output_not_contains
            value: "failed"
          - type: output_not_contains
            value: "SecureDesktop"

      - name: "Close Paint"
        prompt: |
          Close Paint.
        assertions:
          - type: no_hallucinated_tools

