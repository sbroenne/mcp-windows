# =============================================================================
# App Tool UWP Test - Tests launching UWP/Windows Store apps via the app() tool
# =============================================================================
#
# This validates the dynamic stub detection for apps like Calculator that exit
# immediately and spawn a separate UWP process under ApplicationFrameHost.
#
# The app() tool must detect when a process exits quickly with exit code 0
# (indicating a UWP stub) and then search for windows by title instead of PID.
#
# Tools Covered:
#   - app: Launch applications (primary focus - UWP stub detection)
#   - window_management: Verify windows exist and close them
#
# Prerequisites:
#   - Windows 10/11
#   - Windows MCP Server with dynamic stub detection
#   - Environment: AZURE_OPENAI_ENDPOINT
#
# =============================================================================

criteria:
  success_rate: 1  # 100% required

providers:
  - name: azure-openai-gpt41
    type: AZURE
    auth_type: entra_id
    model: gpt-4.1
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview
    retry:
      retry_on_429: true
      max_retries: 5

  - name: azure-openai-gpt52
    type: AZURE
    auth_type: entra_id
    model: gpt-5.2-chat
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview

servers:
  - name: windows-mcp
    type: stdio
    command: "{{SERVER_COMMAND}}"
    server_delay: 10s

agents:
  - name: gpt41-agent
    servers:
      - name: windows-mcp
    provider: azure-openai-gpt41
    system_prompt: |
      You are {{AGENT_NAME}}, an autonomous Windows automation agent using {{PROVIDER_NAME}}.
      Session: {{SESSION_NAME}}

      CRITICAL RULES:
      - Execute all tasks IMMEDIATELY without asking for confirmation
      - NEVER ask "Would you like me to...", "Should I proceed...", or similar questions
      - NEVER request clarification - make reasonable assumptions and proceed
      - Use available tools directly to complete the requested tasks
      - Report results after completion, not before starting
    clarification_detection:
      enabled: true
      level: warning
      judge_provider: azure-openai-gpt52

ai_summary:
  enabled: true
  judge_provider: azure-openai-gpt52

settings:
  verbose: true
  max_iterations: 15
  session_delay: 5s
  test_delay: 2s
  tool_timeout: 60s

sessions:
  # ==========================================================================
  # Session 1: Launch Calculator via App Tool (UWP Stub Test)
  # ==========================================================================
  - name: "Calculator via App Tool"
    tests:
      - name: "Cleanup - Close existing Calculator windows"
        prompt: |
          Close any existing Calculator windows that may be open.
        assertions:
          - type: no_hallucinated_tools

      - name: "Launch Calculator using app tool"
        prompt: |
          Launch Calculator using the app tool with programPath set to "calc.exe".
          Report whether the launch was successful and what window handle was returned.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: app
          - type: output_regex
            pattern: "(?i)(calculator|launched|success|handle|window)"

      - name: "Verify Calculator window exists"
        prompt: |
          Verify that Calculator is now open by finding its window using window_management.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: window_management
          - type: output_regex
            pattern: "(?i)(calculator|found|open|visible)"

      - name: "Close Calculator"
        prompt: |
          Close the Calculator window.
        assertions:
          - type: no_hallucinated_tools
          - type: output_regex
            pattern: "(?i)(calculator|closed|success)"

  # ==========================================================================
  # Session 2: Launch Notepad via App Tool (Control - Win32 App)
  # ==========================================================================
  - name: "Notepad via App Tool (Control)"
    tests:
      - name: "Cleanup - Close existing Notepad windows"
        prompt: |
          Close any existing Notepad windows that may be open.
        assertions:
          - type: no_hallucinated_tools

      - name: "Launch Notepad using app tool"
        prompt: |
          Launch Notepad using the app tool with programPath set to "notepad.exe".
          Report whether the launch was successful and what window handle was returned.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: app
          - type: output_regex
            pattern: "(?i)(notepad|launched|success|handle|window)"

      - name: "Verify Notepad window exists"
        prompt: |
          Verify that Notepad is now open by finding its window using window_management.
        assertions:
          - type: no_hallucinated_tools
          - type: tool_called
            tool: window_management
          - type: output_regex
            pattern: "(?i)(notepad|found|open|visible)"

      - name: "Close Notepad"
        prompt: |
          Close the Notepad window without saving.
        assertions:
          - type: no_hallucinated_tools
          - type: output_regex
            pattern: "(?i)(notepad|closed|success)"
